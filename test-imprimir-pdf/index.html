<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Xubio - Imprimir PDF</title>
    <link rel="stylesheet" href="./assets/styles.css">
</head>
<body>
    <div id="app">
    <div class="container">
        <h1>üß™ Test Xubio - Imprimir PDF</h1>
        <p class="subtitle">Prueba completa: Facturas y Cobranzas con obtenci√≥n de PDF</p>

        <!-- Secci√≥n 1: Autenticaci√≥n -->
        <div class="section">
            <h2>1. Autenticaci√≥n</h2>
            <div class="info">
                üí° Las credenciales est√°n en el archivo <code>.xubio-credentials.md</code><br>
                ‚úÖ Desplegado en Vercel - El proxy API funciona autom√°ticamente
            </div>
            <div class="form-group">
                <label for="clientId">Client ID:</label>
                <input type="text" id="clientId" v-model="clientId" placeholder="Ingresa tu Client ID">
            </div>
            <div class="form-group">
                <label for="secretId">Secret ID:</label>
                <input type="password" id="secretId" v-model="secretId" placeholder="Ingresa tu Secret ID">
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="guardarCredenciales" v-model="guardarCredenciales">
                <label for="guardarCredenciales" style="font-weight: normal; margin: 0;">Guardar credenciales en localStorage</label>
            </div>
            <button @click="obtenerToken()" :disabled="isLoading">Obtener Token</button>
            <button class="btn-danger" @click="limpiarCredenciales()" :disabled="isLoading">Limpiar Credenciales</button>
            <div v-if="isLoading && loadingContext.includes('token')" class="info">‚è≥ {{ loadingContext }}...</div>
            <div v-if="tokenResult.visible" :class="['result', tokenResult.type]" v-html="formatoMensaje(tokenResult.message)"></div>
        </div>

        <!-- Secci√≥n 2: Productos y Lista de Precios -->
        <div class="section">
            <h2>2. Productos y Lista de Precios</h2>
            <div class="info">
                üí° Lista productos activos y selecciona los que quieras incluir en la factura
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button @click="listarProductos()" :disabled="isLoading">üì¶ Listar Productos Activos</button>
                <button @click="listarProductos(true)" :disabled="isLoading" class="test-btn" title="Forzar actualizaci√≥n desde la API">üîÑ Actualizar</button>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                üí° Los productos se cargan desde cache si est√°n disponibles. Usa "Actualizar" para obtener datos frescos.
            </div>
            <div v-if="productosListResult.visible" :class="['result', productosListResult.type]" v-html="formatoMensaje(productosListResult.message)"></div>
            
            <div v-if="productosList.length > 0" style="margin-top: 15px;">
                <div class="form-group">
                    <label for="selectorProducto">‚ûï Agregar Producto:</label>
                    <div style="position: relative;">
                        <input 
                            type="text" 
                            id="selectorProducto" 
                            v-model="busquedaProducto" 
                            @input="mostrarDropdownProductos = true"
                            @focus="mostrarDropdownProductos = true"
                            @blur="setTimeout(() => mostrarDropdownProductos = false, 200)"
                            placeholder="Buscar producto por nombre, c√≥digo o descripci√≥n..."
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <div 
                            v-if="mostrarDropdownProductos && productosFiltrados().length > 0"
                            style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 2px;">
                            <div 
                                v-for="producto in productosFiltrados()" 
                                :key="producto.id || producto.ID"
                                @click="seleccionarProductoDelDropdown(producto)"
                                style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;"
                                @mouseenter="$event.target.style.backgroundColor = '#f5f5f5'"
                                @mouseleave="$event.target.style.backgroundColor = 'white'">
                                <div>
                                    <strong>{{ producto.nombre || producto.codigo || 'Sin nombre' }}</strong>
                                    <div style="font-size: 12px; color: #666;">
                                        C√≥digo: {{ producto.codigo || 'N/A' }}
                                    </div>
                                </div>
                                <div style="font-weight: bold; color: #2196F3;">
                                    <span v-if="producto.precioAGDP || producto.precio">
                                        ${{ formatearPrecio(producto.precioAGDP || producto.precio) }}
                                    </span>
                                    <span v-else style="color: #999; font-size: 11px;">
                                        Sin precio
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div 
                            v-if="mostrarDropdownProductos && productosFiltrados().length === 0 && busquedaProducto.trim()"
                            style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; padding: 10px; z-index: 1000; margin-top: 2px;">
                            <div style="color: #666; text-align: center;">No se encontraron productos</div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="productosSeleccionados.length > 0" style="margin-top: 20px;">
                <h3>Productos Seleccionados:</h3>
                <table class="facturas-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unit.</th>
                            <th>Subtotal</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(item, index) in productosSeleccionados" :key="index">
                            <td>{{ item.producto.nombre || item.producto.codigo || 'Sin nombre' }}</td>
                            <td>
                                <input type="number" v-model.number="item.cantidad" min="0.01" step="0.01" style="width: 80px;">
                            </td>
                            <td>
                                <input type="number" v-model.number="item.precio" min="0" step="0.01" style="width: 100px;">
                            </td>
                            <td>${{ (item.cantidad * item.precio).toFixed(2) }}</td>
                            <td>
                                <button class="test-btn" @click="eliminarProducto(index)">Eliminar</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Secci√≥n 2.5: Clientes -->
        <div class="section">
            <h2>2.5. Clientes</h2>
            <div class="info">
                üí° Lista clientes activos y selecciona el que quieras usar en la factura
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button @click="listarClientes()" :disabled="isLoading">üë• Listar Clientes Activos</button>
                <button @click="listarClientes(true)" :disabled="isLoading" class="test-btn" title="Forzar actualizaci√≥n desde la API">üîÑ Actualizar</button>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                üí° Los clientes se cargan desde cache si est√°n disponibles. Usa "Actualizar" para obtener datos frescos.
            </div>
            <div v-if="clientesListResult.visible" :class="['result', clientesListResult.type]" v-html="formatoMensaje(clientesListResult.message)"></div>
            
            <div v-if="clientesList.length > 0" style="margin-top: 15px;">
                <div class="form-group">
                    <label for="selectorCliente">üîç Buscar Cliente:</label>
                    <div style="position: relative;">
                        <input 
                            type="text" 
                            id="selectorCliente" 
                            v-model="busquedaCliente" 
                            @input="mostrarDropdownClientes = true"
                            @focus="mostrarDropdownClientes = true"
                            @blur="setTimeout(() => mostrarDropdownClientes = false, 200)"
                            placeholder="Buscar por CUIT, raz√≥n social o nombre..."
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <div 
                            v-if="mostrarDropdownClientes && clientesFiltrados().length > 0"
                            style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 2px;">
                            <div 
                                v-for="cliente in clientesFiltrados()" 
                                :key="cliente.cliente_id || cliente.id || cliente.ID"
                                @click="seleccionarClienteDelDropdown(cliente)"
                                style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;"
                                @mouseenter="$event.target.style.backgroundColor = '#f5f5f5'"
                                @mouseleave="$event.target.style.backgroundColor = 'white'">
                                <div>
                                    <strong>{{ cliente.razonSocial || cliente.nombre || 'Sin nombre' }}</strong>
                                    <div style="font-size: 12px; color: #666;">
                                        CUIT: {{ formatearCUIT(cliente.cuit || cliente.identificacionTributaria?.numero || '') || 'N/A' }}
                                        <span v-if="cliente.cliente_id || cliente.id || cliente.ID" style="margin-left: 10px;">
                                            | ID: {{ cliente.cliente_id || cliente.id || cliente.ID }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div 
                            v-if="mostrarDropdownClientes && clientesFiltrados().length === 0 && busquedaCliente.trim()"
                            style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; padding: 10px; z-index: 1000; margin-top: 2px;">
                            <div style="color: #666; text-align: center;">No se encontraron clientes</div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="clienteSeleccionado" style="margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 4px; border: 1px solid #4caf50;">
                <strong>‚úÖ Cliente Seleccionado:</strong>
                <div style="margin-top: 5px;">
                    <strong>{{ clienteSeleccionado.razonSocial || clienteSeleccionado.nombre || 'Sin nombre' }}</strong>
                    <div style="font-size: 12px; color: #666; margin-top: 3px;">
                        CUIT: {{ formatearCUIT(clienteSeleccionado.cuit || clienteSeleccionado.identificacionTributaria?.numero || '') || 'N/A' }}
                        <span v-if="clienteSeleccionado.cliente_id || clienteSeleccionado.id || clienteSeleccionado.ID" style="margin-left: 10px;">
                            | ID: {{ clienteSeleccionado.cliente_id || clienteSeleccionado.id || clienteSeleccionado.ID }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n 3: Flujo Completo - Factura -->
        <div class="section">
            <h2>3. Flujo Completo: Factura ‚Üí PDF</h2>
            <div class="info">
                üí° Este flujo crea una factura y autom√°ticamente obtiene su PDF
            </div>
            
            <!-- Cliente ID oculto (funcional pero no visible) -->
            <input 
                type="hidden" 
                id="facturaClienteId" 
                v-model="facturaClienteId" 
                @input="formatearCUITInput($event)">
            
            <!-- Card de Cliente Seleccionado -->
            <div v-if="clienteSeleccionadoParaFactura" style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">üë§ Cliente</div>
                        <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">
                            {{ clienteSeleccionadoParaFactura.razonSocial || clienteSeleccionadoParaFactura.nombre || 'Sin nombre' }}
                        </div>
                        <div style="font-size: 14px; opacity: 0.9;">
                            <strong>CUIT:</strong> {{ formatearCUIT(clienteSeleccionadoParaFactura.cuit || clienteSeleccionadoParaFactura.identificacionTributaria?.numero || '') || 'N/A' }}
                        </div>
                    </div>
                    <button 
                        @click="limpiarClienteFactura()" 
                        style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;"
                        title="Cambiar cliente">
                        ‚úï Cambiar
                    </button>
                </div>
            </div>
            
            <!-- Mensaje si no hay cliente seleccionado -->
            <div v-if="!clienteSeleccionadoParaFactura" style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; color: #856404;">
                <div style="font-weight: bold; margin-bottom: 5px;">‚ö†Ô∏è No hay cliente seleccionado</div>
                <div style="font-size: 14px;">Por favor, selecciona un cliente desde la secci√≥n "2.5. Clientes" arriba.</div>
            </div>
            
            <!-- Card de Productos Seleccionados -->
            <div v-if="productosSeleccionados.length > 0" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;">
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 12px; color: #495057;">
                    üì¶ Productos en la Factura ({{ productosSeleccionados.length }})
                </div>
                <div style="max-height: 200px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #dee2e6;">
                                <th style="text-align: left; padding: 8px; font-size: 12px; color: #6c757d;">Producto</th>
                                <th style="text-align: right; padding: 8px; font-size: 12px; color: #6c757d;">Cant.</th>
                                <th style="text-align: right; padding: 8px; font-size: 12px; color: #6c757d;">Precio Unit.</th>
                                <th style="text-align: right; padding: 8px; font-size: 12px; color: #6c757d;">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(item, index) in productosSeleccionados" :key="index" style="border-bottom: 1px solid #e9ecef;">
                                <td style="padding: 8px; font-size: 14px;">{{ item.producto.nombre || item.producto.codigo || 'Sin nombre' }}</td>
                                <td style="text-align: right; padding: 8px; font-size: 14px;">{{ item.cantidad }}</td>
                                <td style="text-align: right; padding: 8px; font-size: 14px;">${{ formatearPrecio(item.precio) }}</td>
                                <td style="text-align: right; padding: 8px; font-size: 14px; font-weight: bold;">${{ formatearPrecio(item.cantidad * item.precio) }}</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr style="border-top: 2px solid #dee2e6;">
                                <td colspan="3" style="text-align: right; padding: 8px; font-weight: bold; font-size: 16px;">Total:</td>
                                <td style="text-align: right; padding: 8px; font-weight: bold; font-size: 16px; color: #28a745;">
                                    ${{ formatearPrecio(totalProductosSeleccionados) }}
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
            <!-- Mensaje si no hay productos -->
            <div v-if="productosSeleccionados.length === 0" style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; color: #856404;">
                <div style="font-weight: bold; margin-bottom: 5px;">‚ö†Ô∏è No hay productos seleccionados</div>
                <div style="font-size: 14px;">Por favor, selecciona productos desde la secci√≥n "2. Productos y Lista de Precios" arriba.</div>
            </div>
            <div class="form-group">
                <label for="facturaTipoimpresion">Tipo Impresi√≥n (para PDF):</label>
                <input type="number" id="facturaTipoimpresion" v-model="facturaTipoimpresion" placeholder="Ej: 1">
                <div class="test-values">
                    <button class="test-btn" @click="facturaTipoimpresion = '1'">1</button>
                    <button class="test-btn" @click="facturaTipoimpresion = '2'">2</button>
                    <button class="test-btn" @click="facturaTipoimpresion = '3'">3</button>
                </div>
            </div>
            <div class="form-group">
                <label for="facturaCotizacion">Cotizaci√≥n (USD):</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" id="facturaCotizacion" v-model.number="facturaCotizacion" step="0.01" min="0.01" placeholder="Ej: 1.00" style="flex: 1;">
                    <button class="test-btn" @click="obtenerCotizacionBCRA()" :disabled="isLoading">
                        üí± Actualizar
                    </button>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    üí° Cotizaci√≥n del d√≥lar. Se actualiza autom√°ticamente al cargar la p√°gina. √öltima actualizaci√≥n: <span v-if="cotizacionActualizada">{{ cotizacionActualizada }}</span><span v-else>No disponible</span>
                </div>
            </div>
            <div class="form-group">
                <label for="facturaJson">JSON de Factura (opcional):</label>
                <textarea id="facturaJson" v-model="facturaJson" placeholder='Dejar vac√≠o para usar productos seleccionados'></textarea>
            </div>
            <div class="flow-buttons">
                <button class="btn-secondary" @click="flujoCompletoFactura()" :disabled="isLoading">üöÄ Crear Factura y Obtener PDF</button>
                <button @click="soloCrearFactura()" :disabled="isLoading">Solo Crear Factura</button>
            </div>
            <div v-if="facturaResult.visible" :class="['result', facturaResult.type]" v-html="formatoMensaje(facturaResult.message)"></div>
            <div v-if="facturaPdfViewerVisible" class="pdf-viewer" v-html="facturaPdfViewerHtml"></div>
        </div>

        <!-- Secci√≥n 4: Flujo Completo - Cobranza -->
        <div class="section">
            <h2>3. Flujo Completo: Cobranza ‚Üí PDF</h2>
            <div class="info">
                üí° Este flujo crea una cobranza asociada a una factura y autom√°ticamente obtiene su PDF
            </div>
            <div class="form-group">
                <label for="cobranzaClienteId">Cliente ID:</label>
                <input 
                    type="text" 
                    id="cobranzaClienteId" 
                    v-model="cobranzaClienteId" 
                    placeholder="ID del cliente (usa la b√∫squeda de clientes arriba)"
                    @input="formatearCUITInput($event)"
                    style="width: 100%;">
            </div>
            <div class="form-group">
                <label for="cobranzaIdComprobante">ID Comprobante (Factura a cobrar):</label>
                <input type="number" id="cobranzaIdComprobante" v-model="cobranzaIdComprobante" placeholder="ID de la factura a cobrar">
            </div>
            <div class="form-group">
                <label for="cobranzaImporte">Importe a Aplicar:</label>
                <input type="number" id="cobranzaImporte" v-model="cobranzaImporte" placeholder="Ej: 1000" step="0.01">
            </div>
            <div class="form-group">
                <label for="cobranzaTipoimpresion">Tipo Impresi√≥n (para PDF):</label>
                <input type="number" id="cobranzaTipoimpresion" v-model="cobranzaTipoimpresion" placeholder="Ej: 1">
                <div class="test-values">
                    <button class="test-btn" @click="cobranzaTipoimpresion = '1'">1</button>
                    <button class="test-btn" @click="cobranzaTipoimpresion = '2'">2</button>
                    <button class="test-btn" @click="cobranzaTipoimpresion = '3'">3</button>
                </div>
            </div>
            <div class="form-group">
                <label for="cobranzaJson">JSON de Cobranza (opcional):</label>
                <textarea id="cobranzaJson" v-model="cobranzaJson" placeholder='Dejar vac√≠o para generar autom√°ticamente'></textarea>
            </div>
            <div class="flow-buttons">
                <button class="btn-secondary" @click="flujoCompletoCobranza()" :disabled="isLoading">üöÄ Crear Cobranza y Obtener PDF</button>
                <button @click="soloCrearCobranza()" :disabled="isLoading">Solo Crear Cobranza</button>
            </div>
            <div v-if="cobranzaResult.visible" :class="['result', cobranzaResult.type]" v-html="formatoMensaje(cobranzaResult.message)"></div>
            <div v-if="cobranzaPdfViewerVisible" class="pdf-viewer" v-html="cobranzaPdfViewerHtml"></div>
        </div>

        <!-- Secci√≥n 5: Listar Facturas del √öltimo Mes -->
        <div class="section">
            <h2>4. Listar Facturas del √öltimo Mes</h2>
            <div class="info">
                üí° Trae las facturas del √∫ltimo mes y selecciona una para usar su ID
            </div>
            <button @click="listarFacturasUltimoMes()" :disabled="isLoading">üìã Traer Facturas del √öltimo Mes</button>
            <div v-if="facturasListResult.visible" :class="['result', facturasListResult.type]" v-html="formatoMensaje(facturasListResult.message)"></div>
            <div v-if="facturasList.length > 0" style="margin-top: 15px;">
                <table class="facturas-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>N√∫mero</th>
                            <th>Fecha</th>
                            <th>CUIT</th>
                            <th>Raz√≥n Social</th>
                            <th>Monto</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="factura in facturasList" :key="factura.id" 
                            :class="{ selected: facturaSeleccionada === factura.id }"
                            @click="seleccionarFactura(factura)"
                            style="cursor: pointer;">
                            <td><strong>{{ factura.id }}</strong></td>
                            <td>{{ factura.numero }}</td>
                            <td>{{ factura.fecha }}</td>
                            <td>{{ factura.cuit }}</td>
                            <td>{{ factura.razonSocial }}</td>
                            <td>${{ parseFloat(factura.monto).toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) }}</td>
                            <td>
                                <button class="test-btn" @click.stop="seleccionarFactura(factura)">Seleccionar</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                    üí° Haz clic en una fila para seleccionarla. Se copiar√° el ID a los campos correspondientes.
                </div>
            </div>
        </div>

        <!-- Secci√≥n 6: Obtener PDF de Comprobante Existente -->
        <div class="section">
            <h2>5. Obtener PDF de Comprobante Existente</h2>
            <div class="info">
                üí° Usa esta secci√≥n para probar diferentes valores de tipoimpresion con un comprobante existente
            </div>
            <div class="form-group">
                <label for="transaccionId">Transaction ID:</label>
                <input type="number" id="transaccionId" v-model="transaccionId" placeholder="Ej: 67519506">
            </div>
            <div class="form-group">
                <label for="tipoimpresion">Tipo Impresi√≥n:</label>
                <input type="number" id="tipoimpresion" v-model="tipoimpresion" placeholder="Ej: 1">
                <div class="test-values">
                    <button class="test-btn" @click="probarTipo(1)">Probar 1</button>
                    <button class="test-btn" @click="probarTipo(2)">Probar 2</button>
                    <button class="test-btn" @click="probarTipo(3)">Probar 3</button>
                    <button class="test-btn" @click="probarTipo(0)">Probar 0</button>
                </div>
            </div>
            <button @click="obtenerPDF()" :disabled="isLoading">Obtener PDF</button>
            <div v-if="pdfResult.visible" :class="['result', pdfResult.type]" v-html="formatoMensaje(pdfResult.message)"></div>
            <div v-if="pdfViewerVisible" class="pdf-viewer" v-html="pdfViewerHtml"></div>
        </div>
    </div>
    </div>

    <!-- Vue 3.4.21 - Versi√≥n espec√≠fica para evitar breaking changes -->
    <script src="https://unpkg.com/vue@3.4.21/dist/vue.global.prod.js"></script>
    <script src="./assets/app.js"></script>
</body>
</html>


