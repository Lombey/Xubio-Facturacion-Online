const e=new Map;function t(t,n,o){return{requestXubio:async function(a,r="GET",s=null,i=null){const c="GET"===r?`${r}:${a}:${i?JSON.stringify(i):""}`:null;if(c&&e.has(c)){const t=e.get(c);if(t)return t}const l=(async()=>{try{n()||await t(!0);let e=`/api/proxy${a}`;if(i){const t=new URLSearchParams;for(const[e,n]of Object.entries(i))null!=n&&t.append(e,String(n));e+="?"+t.toString()}const c={Authorization:`Bearer ${o()}`,Accept:"application/json"};"GET"!==r&&s&&(c["Content-Type"]="application/json");const u={method:r,headers:c,body:"GET"!==r&&s?JSON.stringify(s):void 0},d=await fetch(e,u);let p;try{const e=await d.text();p=e?JSON.parse(e):null}catch(l){const e=l instanceof Error?l.message:String(l);throw new Error(`Error parseando respuesta JSON: ${e}`)}if(401===d.status){await t(!0);const n=o();c.Authorization=`Bearer ${n}`,u.headers=c;const a=await fetch(e,u),r=await a.text();return{response:a,data:r?JSON.parse(r):null}}return{response:d,data:p}}catch(u){throw u}finally{c&&e.delete(c)}})();return c&&e.set(c,l),l}}}function n(){const e={accessToken:null,tokenExpiration:null,clientId:"",secretId:"",guardarCredenciales:!0};function t(){return e.accessToken&&e.tokenExpiration&&Date.now()<e.tokenExpiration-6e4}return{state:e,tokenValido:t,obtenerToken:async function(n=!1,o,a,r,s,i){let c=e.clientId.trim(),l=e.secretId.trim();if(c||(c=localStorage.getItem("xubio_clientId")||""),l||(l=localStorage.getItem("xubio_secretId")||""),c&&l)if(n||!t()){o&&o("token","Obteniendo token...","info");try{const t=await fetch("/api/auth",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({clientId:c,secretId:l})});let n;try{n=await t.json()}catch(u){const e=await t.text().catch(()=>"Sin respuesta"),n=u instanceof Error?u.message:String(u);throw new Error(`Error parseando respuesta del token: ${n}. Respuesta recibida: ${e.substring(0,200)}`)}if(t.ok&&n){e.accessToken=n.access_token||n.token||null;const t=parseInt(n.expires_in||"3600",10);return e.tokenExpiration=Date.now()+1e3*t,e.guardarCredenciales&&e.accessToken&&e.tokenExpiration&&(localStorage.setItem("xubio_clientId",c),localStorage.setItem("xubio_secretId",l),localStorage.setItem("xubio_token",e.accessToken),localStorage.setItem("xubio_tokenExpiration",e.tokenExpiration.toString())),o&&e.accessToken&&e.tokenExpiration&&o("token",`‚úÖ Token obtenido exitosamente!\n\nToken: ${e.accessToken.substring(0,50)}...\nExpira en: ${t} segundos\nV√°lido hasta: ${new Date(e.tokenExpiration).toLocaleString()}`,"success"),r&&await r(),s&&await s(),i&&await i(),e.accessToken}{const e=`‚ùå Error obteniendo token:\n\nStatus: ${t.status} ${t.statusText}\n\n${n.error||n.message||"Error desconocido"}\n\nüí° Revisa la consola del navegador (F12) para m√°s detalles.`;o&&o("token",e,"error")}}catch(d){throw a&&a(d,"Obtenci√≥n de token","token"),d}}else o&&o("token","‚úÖ Token a√∫n v√°lido, no es necesario renovarlo","success");else o&&o("token","Error: Completa Client ID y Secret ID","error")},limpiarCredenciales:function(){localStorage.removeItem("xubio_clientId"),localStorage.removeItem("xubio_secretId"),localStorage.removeItem("xubio_token"),localStorage.removeItem("xubio_tokenExpiration"),e.clientId="",e.secretId="",e.accessToken=null,e.tokenExpiration=null},cargarCredenciales:function(){const t=localStorage.getItem("xubio_clientId"),n=localStorage.getItem("xubio_secretId");t&&(e.clientId=t),n&&(e.secretId=n);const o=localStorage.getItem("xubio_token"),a=localStorage.getItem("xubio_tokenExpiration");return!!(o&&a&&Date.now()<parseInt(a)-6e4)&&(e.accessToken=o||null,e.tokenExpiration=parseInt(a)||null,!0)}}}export{n as a,t as u};
