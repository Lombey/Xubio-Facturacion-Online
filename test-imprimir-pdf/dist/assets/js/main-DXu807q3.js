import{c as e,a as t,b as o,w as r,v as i,F as a,r as n,o as s,t as c,d,e as l}from"./vendor-vue-Dcu8Akz5.js";import{f as u,d as p,a as h,b as m,c as b}from"./utils-CXRB53Ve.js";import{u as f,a as g}from"./composables-84mZ5aAL.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const o of e)if("childList"===o.type)for(const e of o.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const D=(e,t)=>{const o=e.__vccOpts||e;for(const[r,i]of t)o[r]=i;return o},C={class:"producto-selector"},P={class:"form-group"},I={style:{position:"relative"}},y={key:0,class:"dropdown-productos"},v=["onClick"],S={style:{"font-size":"12px",color:"#666"}},w={style:{"font-weight":"bold",color:"#2196F3"}},T={key:0},A={key:1,style:{color:"#999","font-size":"11px"}},k={key:1,class:"dropdown-empty"},z={key:0,class:"productos-seleccionados"},x={class:"facturas-table"},L=["onUpdate:modelValue"],E=["onUpdate:modelValue"],$=["onClick"];const F=D({name:"ProductoSelector",props:{productos:{type:Array,default:()=>[]},productosSeleccionados:{type:Array,default:()=>[]}},emits:["select-producto","remove-producto"],data:()=>({busquedaProducto:"",busquedaDebounced:"",mostrarDropdown:!1}),created(){this.debouncedBusqueda=p(e=>{this.busquedaDebounced=e},300)},watch:{busquedaProducto(e){this.debouncedBusqueda(e)}},computed:{productosFiltrados(){if(!this.busquedaDebounced.trim())return this.productos;const e=this.busquedaDebounced.toLowerCase();return this.productos.filter(t=>{const o=(t.nombre||"").toLowerCase(),r=(t.codigo||"").toLowerCase(),i=(t.descripcion||"").toLowerCase();return o.includes(e)||r.includes(e)||i.includes(e)})}},methods:{formatearPrecio:u,seleccionarProducto(e){this.$emit("select-producto",e),this.busquedaProducto="",this.mostrarDropdown=!1},ocultarDropdown(){setTimeout(()=>{this.mostrarDropdown=!1},200)}}},[["render",function(d,l,u,p,h,m){return s(),e("div",C,[t("div",P,[l[5]||(l[5]=t("label",{for:"selectorProducto"},"‚ûï Agregar Producto:",-1)),t("div",I,[r(t("input",{type:"text",id:"selectorProducto","onUpdate:modelValue":l[0]||(l[0]=e=>h.busquedaProducto=e),onInput:l[1]||(l[1]=e=>h.mostrarDropdown=!0),onFocus:l[2]||(l[2]=e=>h.mostrarDropdown=!0),onBlur:l[3]||(l[3]=(...e)=>m.ocultarDropdown&&m.ocultarDropdown(...e)),placeholder:"Buscar producto por nombre, c√≥digo o descripci√≥n...",style:{width:"100%",padding:"8px",border:"1px solid #ddd","border-radius":"4px"}},null,544),[[i,h.busquedaProducto]]),h.mostrarDropdown&&m.productosFiltrados.length>0?(s(),e("div",y,[(s(!0),e(a,null,n(m.productosFiltrados,o=>(s(),e("div",{key:o.id||o.ID,onClick:e=>m.seleccionarProducto(o),class:"dropdown-item"},[t("div",null,[t("strong",null,c(o.nombre||o.codigo||"Sin nombre"),1),t("div",S," C√≥digo: "+c(o.codigo||"N/A"),1)]),t("div",w,[o.precioAGDP||o.precio?(s(),e("span",T," $"+c(m.formatearPrecio(o.precioAGDP||o.precio)),1)):(s(),e("span",A," Sin precio "))])],8,v))),128))])):o("",!0),h.mostrarDropdown&&0===m.productosFiltrados.length&&h.busquedaProducto.trim()?(s(),e("div",k,[...l[4]||(l[4]=[t("div",{style:{color:"#666","text-align":"center"}},"No se encontraron productos",-1)])])):o("",!0)])]),u.productosSeleccionados.length>0?(s(),e("div",z,[l[7]||(l[7]=t("h3",null,"Productos Seleccionados:",-1)),t("table",x,[l[6]||(l[6]=t("thead",null,[t("tr",null,[t("th",null,"Producto"),t("th",null,"Cantidad"),t("th",null,"Precio Unit."),t("th",null,"Subtotal"),t("th",null,"Acci√≥n")])],-1)),t("tbody",null,[(s(!0),e(a,null,n(u.productosSeleccionados,(o,a)=>(s(),e("tr",{key:a},[t("td",null,c(o.producto.nombre||o.producto.codigo||"Sin nombre"),1),t("td",null,[r(t("input",{type:"number","onUpdate:modelValue":e=>o.cantidad=e,min:"0.01",step:"0.01",style:{width:"80px"}},null,8,L),[[i,o.cantidad,void 0,{number:!0}]])]),t("td",null,[r(t("input",{type:"number","onUpdate:modelValue":e=>o.precio=e,min:"0",step:"0.01",style:{width:"100px"}},null,8,E),[[i,o.precio,void 0,{number:!0}]])]),t("td",null,"$"+c((o.cantidad*o.precio).toFixed(2)),1),t("td",null,[t("button",{class:"test-btn",onClick:e=>d.$emit("remove-producto",a)},"Eliminar",8,$)])]))),128))])])])):o("",!0)])}],["__scopeId","data-v-e00658b9"]]),R={class:"cliente-selector"},V={class:"form-group"},G={style:{position:"relative"}},N={key:0,class:"dropdown-clientes"},O=["onClick"],_={style:{"font-size":"12px",color:"#666"}},q={key:0,style:{"margin-left":"10px"}},B={key:1,class:"dropdown-empty"},U={key:0,style:{"margin-top":"15px",padding:"10px",background:"#e8f5e9","border-radius":"4px",border:"1px solid #4caf50"}},J={style:{"margin-top":"5px"}},M={style:{"font-size":"12px",color:"#666","margin-top":"3px"}},X={key:0,style:{"margin-left":"10px"}};const j=D({name:"ClienteSelector",props:{clientes:{type:Array,default:()=>[]},clienteSeleccionado:{type:Object,default:null}},emits:["select-cliente"],data:()=>({busquedaCliente:"",busquedaDebounced:"",mostrarDropdown:!1}),created(){this.debouncedBusqueda=p(e=>{this.busquedaDebounced=e},300)},watch:{busquedaCliente(e){this.debouncedBusqueda(e)}},computed:{clientesFiltrados(){if(!this.busquedaDebounced.trim())return this.clientes;const e=this.busquedaDebounced.toLowerCase().replace(/[-\s]/g,"");return this.clientes.filter(t=>{var o,r;const i=(t.razonSocial||"").toLowerCase(),a=(t.nombre||"").toLowerCase(),n=h(t.cuit||(null==(o=t.identificacionTributaria)?void 0:o.numero)||"").replace(/[-\s]/g,"").toLowerCase(),s=(t.cuit||(null==(r=t.identificacionTributaria)?void 0:r.numero)||"").replace(/[-\s]/g,"").toLowerCase();return i.includes(e)||a.includes(e)||n.includes(e)||s.includes(e)})}},methods:{formatearCUIT:h,seleccionarCliente(e){this.$emit("select-cliente",e),this.busquedaCliente="",this.mostrarDropdown=!1},ocultarDropdown(){setTimeout(()=>{this.mostrarDropdown=!1},200)}}},[["render",function(l,u,p,h,m,b){var f;return s(),e("div",R,[t("div",V,[u[5]||(u[5]=t("label",{for:"selectorCliente"},"üîç Buscar Cliente:",-1)),t("div",G,[r(t("input",{type:"text",id:"selectorCliente","onUpdate:modelValue":u[0]||(u[0]=e=>m.busquedaCliente=e),onInput:u[1]||(u[1]=e=>m.mostrarDropdown=!0),onFocus:u[2]||(u[2]=e=>m.mostrarDropdown=!0),onBlur:u[3]||(u[3]=(...e)=>b.ocultarDropdown&&b.ocultarDropdown(...e)),placeholder:"Buscar por CUIT, raz√≥n social o nombre...",style:{width:"100%",padding:"8px",border:"1px solid #ddd","border-radius":"4px"}},null,544),[[i,m.busquedaCliente]]),m.mostrarDropdown&&b.clientesFiltrados.length>0?(s(),e("div",N,[(s(!0),e(a,null,n(b.clientesFiltrados,r=>{var i;return s(),e("div",{key:r.cliente_id||r.id||r.ID,onClick:e=>b.seleccionarCliente(r),class:"dropdown-item"},[t("div",null,[t("strong",null,c(r.razonSocial||r.nombre||"Sin nombre"),1),t("div",_,[d(" CUIT: "+c(b.formatearCUIT(r.cuit||(null==(i=r.identificacionTributaria)?void 0:i.numero)||"")||"N/A")+" ",1),r.cliente_id||r.id||r.ID?(s(),e("span",q," | ID: "+c(r.cliente_id||r.id||r.ID),1)):o("",!0)])])],8,O)}),128))])):o("",!0),m.mostrarDropdown&&0===b.clientesFiltrados.length&&m.busquedaCliente.trim()?(s(),e("div",B,[...u[4]||(u[4]=[t("div",{style:{color:"#666","text-align":"center"}},"No se encontraron clientes",-1)])])):o("",!0)])]),p.clienteSeleccionado?(s(),e("div",U,[u[6]||(u[6]=t("strong",null,"‚úÖ Cliente Seleccionado:",-1)),t("div",J,[t("strong",null,c(p.clienteSeleccionado.razonSocial||p.clienteSeleccionado.nombre||"Sin nombre"),1),t("div",M,[d(" CUIT: "+c(b.formatearCUIT(p.clienteSeleccionado.cuit||(null==(f=p.clienteSeleccionado.identificacionTributaria)?void 0:f.numero)||"")||"N/A")+" ",1),p.clienteSeleccionado.cliente_id||p.clienteSeleccionado.id||p.clienteSeleccionado.ID?(s(),e("span",X," | ID: "+c(p.clienteSeleccionado.cliente_id||p.clienteSeleccionado.id||p.clienteSeleccionado.ID),1)):o("",!0)])])])):o("",!0)])}],["__scopeId","data-v-86d33381"]]);if(!window.__vueErrorHandlersInitialized){window.__vueErrorHandlersInitialized=!0;const e=e=>{};window.addEventListener("unhandledrejection",e),window.__vueUnhandledRejectionHandler=e}let H="";if("undefined"!=typeof document){const e=document.getElementById("app");e&&(H=e.innerHTML)}async function K(){try{const e=document.getElementById("app");if(!e)throw new Error("No se encontr√≥ el elemento #app");H||e.innerHTML;const t=function(){const e=l({data:()=>({accessToken:null,tokenExpiration:null,clientId:"",secretId:"",guardarCredenciales:!0,tokenResult:{message:"",type:"",visible:!1},facturaClienteId:"",facturaTipoimpresion:"1",facturaCotizacion:"1",facturaMoneda:"ARS",monedasList:[],facturaObservacion:"CC ARS 261-6044134-3 // CBU 0270261410060441340032 // ALIAS corvus.super// Raz√≥n Social CORVUSWEB SRL CUIT 30-71241712-5",modoAvanzado:!1,facturaCondicionPago:1,facturaFechaVto:"",facturaJson:"",facturaResult:{message:"",type:"",visible:!1},facturaPdfViewerHtml:"",facturaPdfViewerVisible:!1,cobranzaClienteId:"",cobranzaIdComprobante:"",cobranzaImporte:"",cobranzaTipoimpresion:"1",cobranzaJson:"",facturasPendientes:[],mostrarFacturasPendientes:!1,facturaParaCobrar:null,cobranzaFormaPago:"efectivo",cobranzaCuentaId:null,cuentasDisponibles:[],cobranzaResult:{message:"",type:"",visible:!1},cobranzaPdfViewerHtml:"",cobranzaPdfViewerVisible:!1,transaccionId:"",tipoimpresion:"1",pdfResult:{message:"",type:"",visible:!1},pdfViewerHtml:"",pdfViewerVisible:!1,facturasList:[],facturasListResult:{message:"",type:"",visible:!1},facturaSeleccionada:null,productosList:[],productosListResult:{message:"",type:"",visible:!1},listaPrecioAGDP:null,productosSeleccionados:[],busquedaProducto:"",mostrarDropdownProductos:!1,clientesList:[],clientesListResult:{message:"",type:"",visible:!1},busquedaCliente:"",mostrarDropdownClientes:!1,clienteSeleccionado:null,clienteSeleccionadoParaFactura:null,cotizacionActualizada:null,centrosDeCosto:[],depositos:[],vendedores:[],circuitosContables:[],puntosDeVenta:[],valoresCargados:!1,isLoading:!1,loadingContext:"",xubioClient:null}),computed:{tokenValido(){return this.accessToken&&this.tokenExpiration&&Date.now()<this.tokenExpiration-6e4},totalProductosSeleccionados(){return this.productosSeleccionados.reduce((e,t)=>e+(parseFloat(t.cantidad)||0)*(parseFloat(t.precio)||0),0)},centroDeCostoSeleccionado(){const e=this.obtenerCentroDeCostoPorDefecto();return{id:e.ID||e.id,nombre:e.nombre||"No disponible",codigo:e.codigo||""}},depositoSeleccionado(){const e=this.obtenerDepositoPorDefecto();return e?{id:e.ID||e.id,nombre:e.nombre||"No disponible",codigo:e.codigo||""}:{nombre:"No disponible",codigo:""}},vendedorSeleccionado(){const e=this.obtenerVendedorPorDefecto();return{id:e.ID||e.id,nombre:e.nombre||"No disponible",codigo:e.codigo||""}},puntoVentaSeleccionado(){const e=this.obtenerPuntoVentaPorDefecto();return{id:e.ID||e.id,nombre:e.nombre||"No disponible",codigo:e.codigo||""}},circuitoContableSeleccionado(){const e=this.obtenerCircuitoContablePorDefecto();return{id:e.ID||e.id,nombre:e.nombre||"No disponible",codigo:e.codigo||""}},subtotalSinIVA(){return this.productosSeleccionados.reduce((e,t)=>e+(parseFloat(t.cantidad)||0)*(parseFloat(t.precio)||0)/1.21,0)},totalIVA(){return this.productosSeleccionados.reduce((e,t)=>{const o=(parseFloat(t.cantidad)||0)*(parseFloat(t.precio)||0);return e+(o-o/1.21)},0)},fechaVencimiento:()=>(new Date).toISOString().split("T")[0]},async mounted(){try{this.xubioClient=f(e=>this.obtenerToken(e),()=>this.tokenValido,()=>this.accessToken);const e=localStorage.getItem("xubio_clientId"),t=localStorage.getItem("xubio_secretId");e&&(this.clientId=e),t&&(this.secretId=t);const o=localStorage.getItem("xubio_token"),r=localStorage.getItem("xubio_tokenExpiration");o&&r&&Date.now()<parseInt(r)-6e4?(this.accessToken=o,this.tokenExpiration=parseInt(r),this.mostrarResultado("token",`‚úÖ Token cargado desde localStorage (v√°lido hasta ${new Date(this.tokenExpiration).toLocaleString()})\n\nüí° Si el token expir√≥, haz clic en "Obtener Token" para renovarlo.`,"success")):e&&t?await this.obtenerToken():this.mostrarResultado("token",'‚ö†Ô∏è Ingresa tus credenciales de Xubio y haz clic en "Obtener Token"\n\nüí° Las credenciales est√°n en el archivo .xubio-credentials.md',"info"),this.limpiarCachesExpirados(),this.facturaFechaVto=(new Date).toISOString().split("T")[0],(this.accessToken||e&&t)&&(this._cotizacionTimeout=setTimeout(async()=>{if(this.accessToken)try{await this.obtenerCotizacionBCRA(!0)}catch(e){}},2e3))}catch(e){this.mostrarResultado("token",`‚ùå Error al inicializar la aplicaci√≥n: ${e.message}\n\nPor favor, recarga la p√°gina. Si el problema persiste, verifica la consola del navegador.`,"error")}},beforeUnmount(){this._cotizacionTimeout&&(clearTimeout(this._cotizacionTimeout),this._cotizacionTimeout=null)},components:{ProductoSelector:F,ClienteSelector:j},methods:{getCachedData:e=>b.getCachedData(e),setCachedData:(e,t,o)=>b.setCachedData(e,t,o),invalidarCache:e=>b.invalidarCache(e),limpiarCachesExpirados:()=>b.limpiarCachesExpirados(),limpiarTodosLosCaches(){return this.clientesList=[],this.productosList=[],this.listaPrecioAGDP=null,b.limpiarTodosLosCaches()},getTTL:e=>b.getTTL(e),formatoMensaje:e=>m(e),mostrarResultado(e,t,o){const r=this[`${e}Result`];r.message=t,r.type=o,r.visible=!0},handleError(e,t,o){const r=e.message||"Error desconocido";this.mostrarResultado(o,`‚ùå Error en ${t}:\n\n${r}\n\nüí° Revisa la consola del navegador (F12) para m√°s detalles.`,"error")},async obtenerToken(e=!1){let t=this.clientId.trim(),o=this.secretId.trim();if(t||(t=localStorage.getItem("xubio_clientId")||""),o||(o=localStorage.getItem("xubio_secretId")||""),t&&o)if(e||!this.tokenValido){this.isLoading=!0,this.loadingContext="Obteniendo token...",this.isLoading=!0,this.loadingContext="Obteniendo token...",this.mostrarResultado("token","Obteniendo token...","info");try{const e=await fetch("/api/auth",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({clientId:t,secretId:o})});let i;try{i=await e.json()}catch(r){const t=await e.text().catch(()=>"Sin respuesta");throw new Error(`Error parseando respuesta del token: ${r.message}. Respuesta recibida: ${t.substring(0,200)}`)}if(e.ok&&i){this.accessToken=i.access_token||i.token;const e=parseInt(i.expires_in||3600,10);this.tokenExpiration=Date.now()+1e3*e,this.guardarCredenciales&&(localStorage.setItem("xubio_clientId",t),localStorage.setItem("xubio_secretId",o),localStorage.setItem("xubio_token",this.accessToken),localStorage.setItem("xubio_tokenExpiration",this.tokenExpiration.toString())),this.mostrarResultado("token",`‚úÖ Token obtenido exitosamente!\n\nToken: ${this.accessToken.substring(0,50)}...\nExpira en: ${e} segundos\nV√°lido hasta: ${new Date(this.tokenExpiration).toLocaleString()}`,"success"),this.valoresCargados||await this.cargarValoresConfiguracion(),await this.obtenerMonedas(),await this.obtenerCuentas()}else{const t=`‚ùå Error obteniendo token:\n\nStatus: ${e.status} ${e.statusText}\n\n${i.error||i.message||"Error desconocido"}\n\nüí° Revisa la consola del navegador (F12) para m√°s detalles.`;this.mostrarResultado("token",t,"error")}}catch(i){this.handleError(i,"Obtenci√≥n de token","token")}finally{this.isLoading=!1,this.loadingContext=""}}else this.mostrarResultado("token","‚úÖ Token a√∫n v√°lido, no es necesario renovarlo","success");else this.mostrarResultado("token","Error: Completa Client ID y Secret ID","error")},limpiarCredenciales(){g().limpiarCredenciales(),this.clientId="",this.secretId="",this.accessToken=null,this.tokenExpiration=null,this.mostrarResultado("token","‚úÖ Credenciales y token eliminados del almacenamiento local","success")},async requestXubio(e,t="GET",o=null,r=null){return this.xubioClient||(this.xubioClient=f(e=>this.obtenerToken(e),()=>this.tokenValido,()=>this.accessToken)),this.xubioClient.requestXubio(e,t,o,r)},async obtenerPDF(e=null,t=null,o="pdf"){if(!this.accessToken)return void alert("Primero obt√©n un token de acceso");const r=e||this.transaccionId.trim(),i=t||this.tipoimpresion.trim(),a="factura"===o?"factura":"cobranza"===o?"cobranza":"pdf",n=`${a}PdfViewer`;if(!r||!i)return void this.mostrarResultado(a,"Error: Completa Transaction ID y Tipo Impresi√≥n","error");const s=parseInt(r,10),c=parseInt(i,10);if(isNaN(s)||s<=0)this.mostrarResultado(a,"Error: Transaction ID debe ser un n√∫mero mayor a 0","error");else if(isNaN(c)||c<=0)this.mostrarResultado(a,"Error: Tipo Impresi√≥n debe ser un n√∫mero mayor a 0","error");else{this.isLoading=!0,this.loadingContext="Obteniendo PDF...",this.mostrarResultado(a,"Obteniendo PDF...","info"),this[`${n}Visible`]=!1;try{const{response:e,data:t}=await this.requestXubio("/imprimirPDF","GET",null,{idtransaccion:s,tipoimpresion:c});if(e.ok&&t.urlPdf){let e="‚úÖ PDF obtenido exitosamente!\n\n";e+=`URL PDF: ${t.urlPdf}\n`,e+=`Nombre XML: ${t.nombrexml||"N/A"}\n`,e+=`DataSource: ${t.datasource||"N/A"}\n\n`,e+=`Respuesta completa:\n${JSON.stringify(t,null,2)}`,this.mostrarResultado(a,e,"success"),this[`${n}Html`]=`\n            <div style="padding: 10px; background: #f0f0f0; display: flex; justify-content: space-between; align-items: center;">\n              <strong>Vista previa del PDF</strong>\n              <div>\n                <a href="${t.urlPdf}" download style="margin-right: 10px; color: #2196F3; text-decoration: none;">‚¨áÔ∏è Descargar</a>\n                <a href="${t.urlPdf}" target="_blank" style="color: #2196F3; text-decoration: none;">üîó Abrir en nueva pesta√±a</a>\n              </div>\n            </div>\n            <iframe src="${t.urlPdf}"></iframe>\n          `,this[`${n}Visible`]=!0}else this.mostrarResultado(a,`‚ùå Error ${e.status}:\n${JSON.stringify(t,null,2)}`,"error")}catch(d){this.handleError(d,"Obtenci√≥n de PDF",a)}finally{this.isLoading=!1,this.loadingContext=""}}},probarTipo(e){this.tipoimpresion=e.toString(),this.obtenerPDF()},async flujoCompletoFactura(){var e,t;if(!this.accessToken)return void alert("Primero obt√©n un token de acceso");let o=this.facturaClienteId.trim();if(o&&o.match(/^\d{2}-\d{8}-\d{1}$/)){const e=o.replace(/\D/g,""),t=this.clientesList.find(t=>{var o;return(t.cuit||(null==(o=t.identificacionTributaria)?void 0:o.numero)||"").replace(/\D/g,"")===e});if(t)o=(t.cliente_id||t.id||t.ID).toString(),this.facturaClienteId=o,this.clienteSeleccionado=t,this.clienteSeleccionadoParaFactura=t;else try{const{response:t,data:r}=await this.requestXubio("/clienteBean","GET",null,{activo:1,numeroIdentificacion:e});if(!(t.ok&&Array.isArray(r)&&r.length>0))return void this.mostrarResultado("factura",`Error: No se encontr√≥ un cliente con CUIT ${o}. Aseg√∫rate de haber listado los clientes primero.`,"error");{const e=r[0];o=(e.cliente_id||e.id||e.ID).toString(),this.facturaClienteId=o,this.clienteSeleccionado=e,this.clienteSeleccionadoParaFactura=e}}catch(r){return void this.mostrarResultado("factura",`Error: No se pudo buscar el cliente con CUIT ${o}. ${r.message}`,"error")}}if(o)if(this.facturaJson.trim()||0!==this.productosSeleccionados.length){this.isLoading=!0,this.loadingContext="Creando factura...",this.mostrarResultado("factura","Creando factura...","info"),this.facturaPdfViewerVisible=!1;try{let r;if(this.facturaJson.trim())r=JSON.parse(this.facturaJson);else{const[e]=await Promise.all([this.obtenerDatosCliente(parseInt(o))]),t=this.productosSeleccionados.map(e=>{var t,o,r,i,a,n,s,c,d,l,u,p;const h=parseFloat(e.cantidad)||1,m=parseFloat(e.precio)||0,b=h*m,f=b-b/(1+((null==(o=null==(t=e.producto)?void 0:t.tasaIva)?void 0:o.porcentaje)||(null==(i=null==(r=e.producto)?void 0:r.tasaIVA)?void 0:i.porcentaje)||(null==(a=e.producto)?void 0:a.porcentajeIVA)||21)/100),g=b,D=e.producto_id||(null==(n=e.producto)?void 0:n.productoid)||(null==(s=e.producto)?void 0:s.id)||(null==(c=e.producto)?void 0:c.ID),C={cantidad:h,precio:m,descripcion:(null==(d=e.producto)?void 0:d.descripcion)||(null==(l=e.producto)?void 0:l.nombre)||"Producto sin descripci√≥n",producto:D?{ID:D,id:D,nombre:(null==(u=e.producto)?void 0:u.nombre)||"",codigo:(null==(p=e.producto)?void 0:p.codigo)||""}:void 0,iva:parseFloat(f.toFixed(2)),importe:parseFloat(b.toFixed(2)),total:parseFloat(g.toFixed(2)),montoExento:0,porcentajeDescuento:0,centroDeCosto:this.obtenerCentroDeCostoPorDefecto()},P=this.obtenerDepositoPorDefecto();return P&&(C.deposito=P),C}),i=(new Date).toISOString().split("T")[0];if(r={circuitoContable:this.obtenerCircuitoContablePorDefecto(),comprobante:1,tipo:1,cliente:{cliente_id:parseInt(o)},fecha:i,fechaVto:this.facturaFechaVto||i,condicionDePago:parseInt(this.facturaCondicionPago)||1,puntoVenta:this.obtenerPuntoVentaPorDefecto(),vendedor:this.obtenerVendedorPorDefecto(),transaccionProductoItems:t,cantComprobantesCancelados:0,cantComprobantesEmitidos:0,cbuinformada:!1,cotizacionListaDePrecio:1,descripcion:"",externalId:"",facturaNoExportacion:!1,listaDePrecio:null,mailEstado:"",nombre:"",numeroDocumento:"",porcentajeComision:0,provincia:null,transaccionCobranzaItems:[],transaccionPercepcionItems:[]},"USD"===this.facturaMoneda||this.facturaMoneda&&"ARS"!==this.facturaMoneda){const e=this.monedasList.find(e=>e.codigo===this.facturaMoneda||"USD"===e.codigo)||await this.obtenerMoneda(this.facturaMoneda);if(e){r.moneda={ID:e.ID||e.id,codigo:e.codigo,nombre:e.nombre};const t=parseFloat(this.facturaCotizacion)||1;r.cotizacion=t>0?t:1,r.utilizaMonedaExtranjera=1}}if(this.facturaObservacion&&this.facturaObservacion.trim()?r.observacion=this.facturaObservacion.trim():r.observacion="",e&&e.identificacionTributaria){const t=e.identificacionTributaria.numero||e.cuit;t&&(r.cliente.identificacionTributaria||(r.cliente.identificacionTributaria={}),r.cliente.identificacionTributaria.numero=t)}}const{response:i,data:a}=await this.requestXubio("/comprobanteVentaBean","POST",r);if(i.ok){const o=a.transaccionId||a.transaccionid||a.id;let r="‚úÖ Factura creada exitosamente!\n\n";r+="üìã Detalles:\n",r+=`‚Ä¢ Transaction ID: ${o}\n`,r+=`‚Ä¢ N√∫mero: ${a.numeroComprobante||a.numero||"N/A"}\n`,r+=`‚Ä¢ Cliente: ${(null==(e=this.clienteSeleccionadoParaFactura)?void 0:e.razonSocial)||(null==(t=this.clienteSeleccionadoParaFactura)?void 0:t.nombre)||"N/A"}\n`,r+=`‚Ä¢ Total: $${this.formatearPrecio(this.totalProductosSeleccionados)} ${this.facturaMoneda}\n`,r+=`‚Ä¢ Moneda: ${this.facturaMoneda}\n\n`,r+="Obteniendo PDF...\n\n",this.mostrarResultado("factura",r,"success"),await this.obtenerPDF(o,this.facturaTipoimpresion,"factura")}else this.mostrarResultado("factura",`‚ùå Error ${i.status}:\n${JSON.stringify(a,null,2)}`,"error")}catch(r){this.handleError(r,"Flujo completo factura","factura")}finally{this.isLoading=!1,this.loadingContext=""}}else this.mostrarResultado("factura","Error: Selecciona al menos un producto o proporciona un JSON de factura","error");else this.mostrarResultado("factura","Error: Completa Cliente ID o selecciona un cliente de la lista","error")},async soloCrearFactura(){if(!this.accessToken)return void alert("Primero obt√©n un token de acceso");let e=this.facturaClienteId.trim();if(e&&e.match(/^\d{2}-\d{8}-\d{1}$/)){const o=e.replace(/\D/g,""),r=this.clientesList.find(e=>{var t;return(e.cuit||(null==(t=e.identificacionTributaria)?void 0:t.numero)||"").replace(/\D/g,"")===o});if(r)e=(r.cliente_id||r.id||r.ID).toString(),this.facturaClienteId=e,this.clienteSeleccionadoParaFactura=r;else try{const{response:t,data:r}=await this.requestXubio("/clienteBean","GET",null,{activo:1,numeroIdentificacion:o});if(!(t.ok&&Array.isArray(r)&&r.length>0))return void this.mostrarResultado("factura",`Error: No se encontr√≥ un cliente con CUIT ${e}. Aseg√∫rate de haber listado los clientes primero.`,"error");{const t=r[0];e=(t.cliente_id||t.id||t.ID).toString(),this.facturaClienteId=e,this.clienteSeleccionadoParaFactura=t}}catch(t){return void this.mostrarResultado("factura",`Error: No se pudo buscar el cliente con CUIT ${e}. ${t.message}`,"error")}}if(e){this.mostrarResultado("factura","Creando factura...","info");try{let t;if(this.facturaJson.trim())t=JSON.parse(this.facturaJson);else{const o=(new Date).toISOString().split("T")[0];t={circuitoContable:this.obtenerCircuitoContablePorDefecto(),comprobante:1,tipo:1,cliente:{cliente_id:parseInt(e)},fecha:o,fechaVto:o,condicionDePago:1,puntoVenta:this.obtenerPuntoVentaPorDefecto(),vendedor:this.obtenerVendedorPorDefecto(),transaccionProductoItems:[{cantidad:1,precio:100,descripcion:"Producto de prueba",iva:parseFloat((100-100/1.21).toFixed(2)),importe:100,total:100,montoExento:0,porcentajeDescuento:0,centroDeCosto:this.obtenerCentroDeCostoPorDefecto()}],cantComprobantesCancelados:0,cantComprobantesEmitidos:0,cbuinformada:!1,cotizacionListaDePrecio:1,descripcion:"",externalId:"",facturaNoExportacion:!1,listaDePrecio:null,mailEstado:"",nombre:"",numeroDocumento:"",porcentajeComision:0,provincia:null,transaccionCobranzaItems:[],transaccionPercepcionItems:[]}}const{response:o,data:r}=await this.requestXubio("/comprobanteVentaBean","POST",t);if(o.ok){const e=r.transaccionId||r.transaccionid||r.id;let t="‚úÖ Factura creada exitosamente!\n\n";t+=`Transaction ID: ${e}\n`,t+=`ID: ${r.id||r.ID||"N/A"}\n\n`,t+=`Respuesta completa:\n${JSON.stringify(r,null,2)}`,e&&(this.transaccionId=e.toString(),t+='\n\nüí° Transaction ID copiado al campo de "Obtener PDF de Comprobante Existente"'),this.mostrarResultado("factura",t,"success")}else this.mostrarResultado("factura",`‚ùå Error ${o.status}:\n${JSON.stringify(r,null,2)}`,"error")}catch(t){this.mostrarResultado("factura",`‚ùå Error: ${t.message}`,"error")}}else this.mostrarResultado("factura","Error: Completa Cliente ID o selecciona un cliente de la lista","error")},async flujoCompletoCobranza(){var e;if(!this.accessToken)return void alert("Primero obt√©n un token de acceso");const t=this.cobranzaClienteId.trim(),o=this.cobranzaIdComprobante.trim(),r=this.cobranzaImporte.trim();if(t&&o&&r){this.mostrarResultado("cobranza","Creando cobranza...","info"),this.cobranzaPdfViewerVisible=!1;try{let i;if(this.cobranzaJson.trim())i=JSON.parse(this.cobranzaJson);else{const a=await this.requestXubio(`/comprobanteVentaBean/${o}`,"GET");if(!a.response.ok)throw new Error("No se pudo obtener el comprobante. Verifica el ID.");const n=a.data;i={circuitoContable:n.circuitoContable||{ID:1},cliente:{cliente_id:parseInt(t)},fecha:(new Date).toISOString().split("T")[0],monedaCtaCte:n.moneda||{ID:1},cotizacion:n.cotizacion||1,utilizaMonedaExtranjera:(null==(e=n.moneda)?void 0:e.codigo)&&"PESOS_ARGENTINOS"!==n.moneda.codigo?1:0,transaccionInstrumentoDeCobro:[{cuentaTipo:1,cuenta:{ID:1,id:1},moneda:n.moneda||{ID:1},cotizacion:n.cotizacion||1,importe:parseFloat(r),descripcion:`Cobranza de factura ${o}`}],detalleCobranzas:[{idComprobante:parseInt(o),importe:parseFloat(r)}]}}const{response:a,data:n}=await this.requestXubio("/cobranzaBean","POST",i);if(a.ok){const e=n.transaccionId||n.transaccionid||n.id;let t="‚úÖ Cobranza creada exitosamente!\n\n";t+=`Transaction ID: ${e}\n`,t+=`ID: ${n.id||n.ID||"N/A"}\n\n`,t+="Obteniendo PDF...\n\n",this.mostrarResultado("cobranza",t,"success"),await this.obtenerPDF(e,this.cobranzaTipoimpresion,"cobranza")}else this.mostrarResultado("cobranza",`‚ùå Error ${a.status}:\n${JSON.stringify(n,null,2)}`,"error")}catch(i){this.mostrarResultado("cobranza",`‚ùå Error: ${i.message}`,"error")}}else this.mostrarResultado("cobranza","Error: Completa Cliente ID, ID Comprobante e Importe","error")},async soloCrearCobranza(){var e;if(!this.accessToken)return void alert("Primero obt√©n un token de acceso");const t=this.cobranzaClienteId.trim(),o=this.cobranzaIdComprobante.trim(),r=this.cobranzaImporte.trim();if(t&&o&&r){this.mostrarResultado("cobranza","Creando cobranza...","info");try{let i;if(this.cobranzaJson.trim())i=JSON.parse(this.cobranzaJson);else{const a=await this.requestXubio(`/comprobanteVentaBean/${o}`,"GET");if(!a.response.ok)throw new Error("No se pudo obtener el comprobante. Verifica el ID.");const n=a.data;i={circuitoContable:n.circuitoContable||{ID:1},cliente:{cliente_id:parseInt(t)},fecha:(new Date).toISOString().split("T")[0],monedaCtaCte:n.moneda||{ID:1},cotizacion:n.cotizacion||1,utilizaMonedaExtranjera:(null==(e=n.moneda)?void 0:e.codigo)&&"PESOS_ARGENTINOS"!==n.moneda.codigo?1:0,transaccionInstrumentoDeCobro:[{cuentaTipo:1,cuenta:{ID:1,id:1},moneda:n.moneda||{ID:1},cotizacion:n.cotizacion||1,importe:parseFloat(r),descripcion:`Cobranza de factura ${o}`}],detalleCobranzas:[{idComprobante:parseInt(o),importe:parseFloat(r)}]}}const{response:a,data:n}=await this.requestXubio("/cobranzaBean","POST",i);if(a.ok){const e=n.transaccionId||n.transaccionid||n.id;let t="‚úÖ Cobranza creada exitosamente!\n\n";t+=`Transaction ID: ${e}\n`,t+=`ID: ${n.id||n.ID||"N/A"}\n\n`,t+=`Respuesta completa:\n${JSON.stringify(n,null,2)}`,e&&(this.transaccionId=e.toString(),t+='\n\nüí° Transaction ID copiado al campo de "Obtener PDF de Comprobante Existente"'),this.mostrarResultado("cobranza",t,"success")}else this.mostrarResultado("cobranza",`‚ùå Error ${a.status}:\n${JSON.stringify(n,null,2)}`,"error")}catch(i){this.mostrarResultado("cobranza",`‚ùå Error: ${i.message}`,"error")}}else this.mostrarResultado("cobranza","Error: Completa Cliente ID, ID Comprobante e Importe","error")},async listarFacturasUltimoMes(){if(this.accessToken){this.mostrarResultado("facturasList","Obteniendo facturas del √∫ltimo mes...","info"),this.facturasList=[];try{const e=new Date,t=new Date;t.setMonth(t.getMonth()-1);const o=t.toISOString().split("T")[0],r=e.toISOString().split("T")[0],{response:i,data:a}=await this.requestXubio("/comprobanteVentaBean","GET",null,{fechaDesde:o,fechaHasta:r});if(i.ok&&Array.isArray(a)){if(0===a.length)return void this.mostrarResultado("facturasList","No se encontraron facturas en el √∫ltimo mes","info");this.facturasList=a.map(e=>{var t;const o=e.id||e.ID||e.transaccionId||e.transaccionid||"",r=e.cliente||{};return{id:o,numero:e.numeroComprobante||e.numero||"",fecha:e.fecha||"",cuit:r.cuit||r.CUIT||(null==(t=r.identificacionTributaria)?void 0:t.numero)||"",razonSocial:r.razonSocial||r.nombre||"",monto:e.importetotal||e.importeTotal||e.total||"0",transaccionId:e.transaccionId||e.transaccionid||o}}),this.mostrarResultado("facturasList",`‚úÖ Se encontraron ${a.length} facturas del √∫ltimo mes`,"success")}else this.mostrarResultado("facturasList",`‚ùå Error ${i.status}:\n${JSON.stringify(a,null,2)}`,"error")}catch(e){this.mostrarResultado("facturasList",`‚ùå Error: ${e.message}`,"error")}}else alert("Primero obt√©n un token de acceso")},seleccionarFactura(e){this.transaccionId=e.transaccionId.toString(),this.cobranzaIdComprobante=e.id.toString(),this.facturaSeleccionada=e.id,this.mostrarResultado("facturasList",`‚úÖ Factura seleccionada:\nID: ${e.id}\nTransaction ID: ${e.transaccionId}\nCliente: ${e.razonSocial}\nCUIT: ${e.cuit}\nMonto: $${parseFloat(e.monto).toLocaleString("es-AR",{minimumFractionDigits:2,maximumFractionDigits:2})}\n\nüí° El ID se copi√≥ a los campos correspondientes.`,"success")},async obtenerListaPrecioAGDP(e=!1){if(!this.accessToken)return null;if(!e&&this.listaPrecioAGDP)return this.listaPrecioAGDP;if(e)this.invalidarCache("listaPrecioAGDP");else{const e=this.getCachedData("listaPrecioAGDP");if(e)return this.listaPrecioAGDP=e,e}try{const{response:e,data:o}=await this.requestXubio("/listaPrecioBean","GET");if(e.ok&&Array.isArray(o)){const e=o.find(e=>"AGDP"===e.nombre||"AGDP"===e.codigo||e.nombre&&e.nombre.toUpperCase().includes("AGDP")||e.codigo&&e.codigo.toUpperCase().includes("AGDP"));if(e){const o=e.listaPrecioID||e.id||e.ID;if(o)try{const{response:t,data:r}=await this.requestXubio(`/listaPrecioBean/${o}`,"GET");if(t.ok&&r)return this.listaPrecioAGDP={...e,...r},this.setCachedData("listaPrecioAGDP",this.listaPrecioAGDP,this.getTTL("listaPrecios")),Array.isArray(this.listaPrecioAGDP.listaPrecioItem)&&this.listaPrecioAGDP.listaPrecioItem.length,this.listaPrecioAGDP}catch(t){}return this.listaPrecioAGDP=e,this.setCachedData("listaPrecioAGDP",e,this.getTTL("listaPrecios")),e}return null}return null}catch(t){return null}},async listarProductos(e=!1){if(this.accessToken)if(!e&&this.productosList.length>0)this.mostrarResultado("productosList",`‚úÖ ${this.productosList.length} productos ya cargados en memoria`,"success");else{if(e)this.invalidarCache("productos");else{const e=this.getCachedData("productos");if(e&&Array.isArray(e)&&e.length>0){this.productosList=e;const t=Math.floor((Date.now()-JSON.parse(localStorage.getItem("xubio_cache_productos")).timestamp)/1e3/60);return this.mostrarResultado("productosList",`‚úÖ ${e.length} productos cargados desde cache (actualizado hace ${t} minutos)\n\nüí° Haz clic en "Actualizar" para obtener datos frescos de la API`,"success"),void this.actualizarProductosEnBackground()}}this.isLoading=!0,this.loadingContext="Obteniendo productos...",this.mostrarResultado("productosList","Obteniendo productos desde la API...","info"),this.productosList=[];try{const{response:e,data:t}=await this.requestXubio("/ProductoVentaBean","GET",null,{activo:1});if(e.ok&&Array.isArray(t)){this.listaPrecioAGDP||await this.obtenerListaPrecioAGDP();const e=await this.enriquecerProductosConPrecios(t);this.productosList=e,this.setCachedData("productos",e,this.getTTL("productos"));const o=e.filter(e=>e.precioAGDP&&e.precioAGDP>0),r=o.length>0?`‚úÖ Se encontraron ${t.length} productos activos (${o.length} con precios de la lista AGDP) - Actualizados desde la API`:`‚úÖ Se encontraron ${t.length} productos activos\n\n‚ö†Ô∏è No se encontraron precios en la lista AGDP. Verifica que:\n- La lista de precios "AGDP" existe\n- Los productos est√°n incluidos en la lista\n- Revisa la consola (F12) para m√°s detalles`;this.mostrarResultado("productosList",r,o.length>0?"success":"info")}else this.mostrarResultado("productosList",`‚ùå Error ${e.status}:\n${JSON.stringify(t,null,2)}`,"error")}catch(t){this.mostrarResultado("productosList",`‚ùå Error: ${t.message}`,"error")}finally{this.isLoading=!1,this.loadingContext=""}}else alert("Primero obt√©n un token de acceso")},async actualizarProductosEnBackground(){try{const{response:e,data:t}=await this.requestXubio("/ProductoVentaBean","GET",null,{activo:1});if(e.ok&&Array.isArray(t)){this.listaPrecioAGDP||await this.obtenerListaPrecioAGDP();const e=await this.enriquecerProductosConPrecios(t);e.length!==this.productosList.length&&(this.productosList=e,this.setCachedData("productos",e,this.getTTL("productos")))}}catch(e){}},async obtenerCotizacionBCRA(e=!1){e||(this.isLoading=!0,this.loadingContext="Obteniendo cotizaci√≥n del d√≥lar...",this.mostrarResultado("factura","Obteniendo cotizaci√≥n del d√≥lar vendedor del d√≠a...","info"));try{const t="https://dolarapi.com/v1/dolares/oficial",o=await fetch(t,{method:"GET",headers:{Accept:"application/json"}});if(!o.ok)throw new Error(`Error ${o.status}: No se pudo obtener la cotizaci√≥n del d√≥lar oficial. ${o.statusText}`);const r=await o.json();if(r&&r.venta){const t=parseFloat(r.venta);if(!isNaN(t)&&t>0){const o=r.fechaActualizacion?new Date(r.fechaActualizacion).toLocaleDateString("es-AR"):"hoy",i=r.fechaActualizacion?new Date(r.fechaActualizacion).toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit"}):"";return this.facturaCotizacion=t.toFixed(2),this.cotizacionActualizada=`${o} ${i}`,void(e||this.mostrarResultado("factura",`‚úÖ Cotizaci√≥n OFICIAL vendedor obtenida: $${t.toFixed(2)} (actualizada ${o} ${i})`,"success"))}}throw new Error("No se pudo obtener la cotizaci√≥n vendedor. La respuesta no contiene el formato esperado.")}catch(t){e||this.mostrarResultado("factura",`‚ùå Error obteniendo cotizaci√≥n del d√≥lar:\n\n${t.message}\n\nüí° Puedes ingresar la cotizaci√≥n manualmente.`,"error")}finally{e||(this.isLoading=!1,this.loadingContext="")}},async obtenerMonedas(){if(this.accessToken)try{const{response:e,data:t}=await this.requestXubio("/monedaBean","GET",null,{activo:1});return e.ok&&Array.isArray(t)?(this.monedasList=t,t):[]}catch(e){return[]}},async obtenerMoneda(e="USD"){if(!this.accessToken)return null;const t=this.monedasList.find(t=>{var o;return t.codigo===e||(null==(o=t.codigo)?void 0:o.toUpperCase())===e.toUpperCase()});if(t)return t;try{const{response:t,data:o}=await this.requestXubio("/monedaBean","GET",null,{activo:1});if(t.ok&&Array.isArray(o)){const t=o.find(t=>{var o,r;return t.codigo===e||(null==(o=t.codigo)?void 0:o.toUpperCase())===e.toUpperCase()||(null==(r=t.nombre)?void 0:r.toUpperCase().includes(e.toUpperCase()))});if(t)return t}return null}catch(o){return null}},async cargarValoresConfiguracion(){if(this.accessToken)try{await Promise.all([this.obtenerCentrosDeCosto(),this.obtenerDepositos(),this.obtenerVendedores(),this.obtenerCircuitosContables(),this.obtenerPuntosDeVenta()]),this.valoresCargados=!0}catch(e){}},async obtenerCentrosDeCosto(){try{const{response:e,data:t}=await this.requestXubio("/centroDeCostoBean","GET",null,{activo:1});return e.ok&&Array.isArray(t)?(this.centrosDeCosto=t,t):[]}catch(e){return[]}},async obtenerDepositos(){try{const{response:e,data:t}=await this.requestXubio("/depositos","GET",null,{activo:1});return e.ok&&Array.isArray(t)?(this.depositos=t,t):[]}catch(e){return[]}},async obtenerVendedores(){try{const{response:e,data:t}=await this.requestXubio("/vendedorBean","GET",null,{activo:1});return e.ok&&Array.isArray(t)?(this.vendedores=t,t):[]}catch(e){return[]}},async obtenerCircuitosContables(){try{const{response:e,data:t}=await this.requestXubio("/circuitoContableBean","GET",null,{activo:1});return e.ok&&Array.isArray(t)?(this.circuitosContables=t,t):[]}catch(e){return[]}},async obtenerPuntosDeVenta(){try{const{response:e,data:t}=await this.requestXubio("/puntoVentaBean","GET",null,{activo:1});return e.ok&&Array.isArray(t)?(this.puntosDeVenta=t,t):[]}catch(e){return[]}},obtenerCentroDeCostoPorDefecto(){if(this.centrosDeCosto&&this.centrosDeCosto.length>0){const e=this.centrosDeCosto[0];return{ID:e.ID||e.id||e.centroDeCosto_id||1,id:e.id||e.ID||e.centroDeCosto_id||1,nombre:e.nombre||"",codigo:e.codigo||""}}return{ID:1,id:1}},obtenerDepositoPorDefecto(){if(this.depositos&&this.depositos.length>0){const e=this.depositos[0];return{ID:e.ID||e.id||e.deposito_id||1,id:e.id||e.ID||e.deposito_id||1,nombre:e.nombre||"",codigo:e.codigo||""}}return null},obtenerCircuitoContablePorDefecto(){if(this.circuitosContables&&this.circuitosContables.length>0){const e=this.circuitosContables[0];return{ID:e.circuitoContable_id||e.ID||e.id||1,id:e.id||e.circuitoContable_id||e.ID||1,nombre:e.nombre||"",codigo:e.codigo||""}}return{ID:1}},obtenerPuntoVentaPorDefecto(){if(this.puntosDeVenta&&this.puntosDeVenta.length>0){const e=this.puntosDeVenta[0];return{ID:e.ID||e.id||e.puntoVenta_id||1,id:e.id||e.ID||e.puntoVenta_id||1,nombre:e.nombre||"",codigo:e.codigo||""}}return{ID:1}},obtenerVendedorPorDefecto(){if(this.vendedores&&this.vendedores.length>0){const e=this.vendedores[0];return{ID:e.ID||e.id||e.vendedor_id||1,id:e.id||e.ID||e.vendedor_id||1,nombre:e.nombre||"",codigo:e.codigo||""}}return{ID:1}},async obtenerDatosCliente(e){if(!this.accessToken||!e)return null;try{const{response:t,data:o}=await this.requestXubio(`/clienteBean/${e}`,"GET");return t.ok&&o?o:null}catch(t){return null}},async enriquecerProductosConPrecios(e){return e&&Array.isArray(e)?(this.listaPrecioAGDP||await this.obtenerListaPrecioAGDP(),e.map(e=>{const t=this.obtenerPrecioProducto(e);return{...e,precioAGDP:t>0?t:null,precio:t>0?t:null}})):e},obtenerPrecioProducto(e){if(!this.listaPrecioAGDP||!e)return 0;const t=e.productoid||e.id||e.ID||e.producto_id;if(!t)return 0;const o=Number(t);if(Array.isArray(this.listaPrecioAGDP.listaPrecioItem)){const e=this.listaPrecioAGDP.listaPrecioItem.find(e=>{if(e.producto){const r=e.producto.productoid||e.producto.id||e.producto.ID;return!!r&&(Number(r)===o||String(r)===String(t)||r===t)}return!1});if(e){const t=parseFloat(e.precio);if(t&&t>0)return t}else this.listaPrecioAGDP.listaPrecioItem.length>0&&this.listaPrecioAGDP.listaPrecioItem[0]}if(this.listaPrecioAGDP.precios&&this.listaPrecioAGDP.precios[t]){const e=this.listaPrecioAGDP.precios[t];return"number"==typeof e?e:e.precio||e.valor||0}if(Array.isArray(this.listaPrecioAGDP.items)){const e=this.listaPrecioAGDP.items.find(e=>{if(e.producto){const r=e.producto.productoid||e.producto.id||e.producto.ID;return Number(r)===o||String(r)===String(t)||r===t}return e.producto_id===t||e.idProducto===t});if(e)return e.precio||e.valor||e.importe||0}if(Array.isArray(this.listaPrecioAGDP.detalle)){const e=this.listaPrecioAGDP.detalle.find(e=>{if(e.producto){const r=e.producto.productoid||e.producto.id||e.producto.ID;return Number(r)===o||String(r)===String(t)||r===t}return e.producto_id===t||e.idProducto===t});if(e)return e.precio||e.valor||e.importe||0}return e.precio?e.precio:0},formatearPrecio:e=>u(e),calcularIVA(e){const t=(parseFloat(e.cantidad)||0)*(parseFloat(e.precio)||0);return parseFloat((t-t/1.21).toFixed(2))},seleccionarProductoDelDropdown(e){this.agregarProducto(e),this.busquedaProducto="",this.mostrarDropdownProductos=!1},agregarProducto(e){const t=e.productoid||e.id||e.ID||e.producto_id;if(this.productosSeleccionados.some(e=>(e.producto_id||e.producto&&(e.producto.productoid||e.producto.id||e.producto.ID))===t))return void this.mostrarResultado("productosList",`‚ö†Ô∏è El producto "${e.nombre||e.codigo||"Sin nombre"}" ya est√° en la lista`,"info");const o=e.precioAGDP||e.precio||this.obtenerPrecioProducto(e)||0,r={producto:e,cantidad:1,precio:o>0?o:0,producto_id:t};this.productosSeleccionados.push(r);const i=o>0?`‚úÖ Producto "${e.nombre||e.codigo||"Sin nombre"}" agregado con precio $${this.formatearPrecio(o)}`:`‚úÖ Producto "${e.nombre||e.codigo||"Sin nombre"}" agregado (precio: $0.00 - editar manualmente)`;this.mostrarResultado("productosList",i,"success")},eliminarProducto(e){this.productosSeleccionados.splice(e,1)},productosFiltrados(){if(!this.busquedaProducto.trim())return this.productosList;const e=this.busquedaProducto.toLowerCase();return this.productosList.filter(t=>{const o=(t.nombre||"").toLowerCase(),r=(t.codigo||"").toLowerCase(),i=(t.descripcion||"").toLowerCase();return o.includes(e)||r.includes(e)||i.includes(e)})},async listarClientes(e=!1){if(this.accessToken)if(!e&&this.clientesList.length>0)this.mostrarResultado("clientesList",`‚úÖ ${this.clientesList.length} clientes ya cargados en memoria`,"success");else{if(e)this.invalidarCache("clientes");else{const e=this.getCachedData("clientes");if(e&&Array.isArray(e)&&e.length>0){this.clientesList=e;const t=Math.floor((Date.now()-JSON.parse(localStorage.getItem("xubio_cache_clientes")).timestamp)/1e3/60);return this.mostrarResultado("clientesList",`‚úÖ ${e.length} clientes cargados desde cache (actualizado hace ${t} minutos)\n\nüí° Haz clic en "Actualizar" para obtener datos frescos de la API`,"success"),void this.actualizarClientesEnBackground()}}this.isLoading=!0,this.loadingContext="Obteniendo clientes...",this.mostrarResultado("clientesList","Obteniendo clientes desde la API...","info");try{const{response:e,data:t}=await this.requestXubio("/clienteBean","GET",null,{activo:1});if(e.ok&&Array.isArray(t)){const e=t.map(e=>{var t;const o=e.cliente_id||e.id||e.ID,r=e.cuit||(null==(t=e.identificacionTributaria)?void 0:t.numero)||e.CUIT||"";return{...e,cliente_id:o,cuit:r,razonSocial:e.razonSocial||e.nombre||"",nombre:e.nombre||e.razonSocial||""}});this.clientesList=e,this.setCachedData("clientes",e,this.getTTL("clientes")),this.mostrarResultado("clientesList",`‚úÖ Se encontraron ${t.length} clientes activos (actualizados desde la API)`,"success")}else this.mostrarResultado("clientesList",`‚ùå Error ${e.status}:\n${JSON.stringify(t,null,2)}`,"error")}catch(t){this.mostrarResultado("clientesList",`‚ùå Error: ${t.message}`,"error")}finally{this.isLoading=!1,this.loadingContext=""}}else alert("Primero obt√©n un token de acceso")},async actualizarClientesEnBackground(){try{const{response:e,data:t}=await this.requestXubio("/clienteBean","GET",null,{activo:1});if(e.ok&&Array.isArray(t)){const e=t.map(e=>{var t;const o=e.cliente_id||e.id||e.ID,r=e.cuit||(null==(t=e.identificacionTributaria)?void 0:t.numero)||e.CUIT||"";return{...e,cliente_id:o,cuit:r,razonSocial:e.razonSocial||e.nombre||"",nombre:e.nombre||e.razonSocial||""}});e.length!==this.clientesList.length&&(this.clientesList=e,this.setCachedData("clientes",e,this.getTTL("clientes")))}}catch(e){}},clientesFiltrados(){if(!this.busquedaCliente.trim())return this.clientesList;const e=this.busquedaCliente.toLowerCase().replace(/[-\s]/g,"");return this.clientesList.filter(t=>{var o,r;const i=(t.razonSocial||"").toLowerCase(),a=(t.nombre||"").toLowerCase(),n=this.formatearCUIT(t.cuit||(null==(o=t.identificacionTributaria)?void 0:o.numero)||"").replace(/[-\s]/g,"").toLowerCase(),s=(t.cuit||(null==(r=t.identificacionTributaria)?void 0:r.numero)||"").replace(/[-\s]/g,"").toLowerCase();return i.includes(e)||a.includes(e)||n.includes(e)||s.includes(e)})},seleccionarClienteDelDropdown(e){var t;const o=e.cliente_id||e.id||e.ID;o&&(this.facturaClienteId=o.toString(),this.cobranzaClienteId=o.toString(),this.clienteSeleccionado=e,this.clienteSeleccionadoParaFactura=e,this.busquedaCliente="",this.mostrarDropdownClientes=!1,this.mostrarResultado("clientesList",`‚úÖ Cliente seleccionado: ${e.razonSocial||e.nombre||"Sin nombre"}\nCUIT: ${this.formatearCUIT(e.cuit||(null==(t=e.identificacionTributaria)?void 0:t.numero)||"")||"N/A"}\nID: ${o}\n\nüí° El cliente se asign√≥ a la factura.`,"success"))},limpiarClienteFactura(){this.clienteSeleccionadoParaFactura=null,this.facturaClienteId="",this.clienteSeleccionado=null},formatearCUIT:e=>h(e),ocultarDropdownProductos(){"undefined"!=typeof window&&window.setTimeout?window.setTimeout(()=>{this.mostrarDropdownProductos=!1},200):this.mostrarDropdownProductos=!1},ocultarDropdownClientes(){"undefined"!=typeof window&&window.setTimeout?window.setTimeout(()=>{this.mostrarDropdownClientes=!1},200):this.mostrarDropdownClientes=!1},async obtenerFacturasPendientes(e){if(this.accessToken&&e){this.isLoading=!0,this.loadingContext="Obteniendo facturas pendientes...";try{const{response:t,data:o}=await this.requestXubio("/comprobantesAsociados","GET",null,{clienteId:parseInt(e),tipoComprobante:1});return t.ok&&Array.isArray(o)?(this.facturasPendientes=o.filter(e=>parseFloat(e.saldo||e.saldoPendiente||e.importeTotal||0)>0),this.mostrarFacturasPendientes=!0,this.mostrarResultado("cobranza",`‚úÖ Se encontraron ${this.facturasPendientes.length} facturas pendientes`,"success"),this.facturasPendientes):(this.mostrarResultado("cobranza",`‚ùå Error obteniendo facturas: ${JSON.stringify(o,null,2)}`,"error"),[])}catch(t){return this.handleError(t,"Obtenci√≥n de facturas pendientes","cobranza"),[]}finally{this.isLoading=!1,this.loadingContext=""}}else this.mostrarResultado("cobranza","Error: Cliente ID requerido","error")},seleccionarFacturaPendiente(e){const t=e.target.value;if(t)try{const e=JSON.parse(t);this.cobranzaIdComprobante=(e.id||e.ID||e.transaccionId).toString(),this.cobranzaImporte=(e.saldo||e.saldoPendiente||e.importeTotal||0).toString(),this.obtenerDatosFactura(this.cobranzaIdComprobante),this.mostrarResultado("cobranza",`‚úÖ Factura seleccionada: ${e.numeroComprobante||e.numero}\nSaldo: $${this.formatearPrecio(parseFloat(this.cobranzaImporte))}`,"success")}catch(o){}else this.facturaParaCobrar=null},async obtenerDatosFactura(e){if(!this.accessToken||!e)return null;try{const{response:t,data:o}=await this.requestXubio(`/comprobanteVentaBean/${e}`,"GET");return t.ok&&o?(this.facturaParaCobrar=o,o):(this.facturaParaCobrar=null,null)}catch(t){return this.facturaParaCobrar=null,null}},async obtenerCuentas(){if(!this.accessToken)return[];try{const{response:e,data:t}=await this.requestXubio("/cuenta","GET",null,{activo:1});return e.ok&&Array.isArray(t)?(this.cuentasDisponibles=t.filter(e=>{var t;return"CAJA"===e.tipo||"BANCO"===e.tipo||1===e.tipoCuenta||(null==(t=e.nombre)?void 0:t.toUpperCase().includes("CAJA"))}),this.cuentasDisponibles):[]}catch(e){return[]}},formatearCUITInput(e){const t=e.target,o=t.value;if(("facturaClienteId"===t.id||"cobranzaClienteId"===t.id)&&o&&/^[\d-]+$/.test(o)){const e=o.replace(/\D/g,"");if(e.length>2&&e.length<=11){let r="";r=e.length<=2?e:e.length<=10?`${e.substring(0,2)}-${e.substring(2)}`:`${e.substring(0,2)}-${e.substring(2,10)}-${e.substring(10,11)}`,r!==o&&this.$nextTick(()=>{"facturaClienteId"===t.id?this.facturaClienteId=r:"cobranzaClienteId"===t.id&&(this.cobranzaClienteId=r)})}}}}});return e.config.errorHandler=(e,t,o)=>{e&&"object"==typeof e&&"message"in e&&e.message},e}();if(!t||"function"!=typeof t.mount)throw new Error("La funci√≥n factory no retorn√≥ una instancia v√°lida de Vue app");const o=e.innerHTML,r=t.mount("#app"),i=document.getElementById("app");return i&&(i.innerHTML=o),setTimeout(()=>{const e=document.getElementById("app");!e||""!==e.innerHTML.trim()&&"\x3c!----\x3e"!==e.innerHTML.trim()||(e.innerHTML=o)},100),requestAnimationFrame(()=>{const e=document.getElementById("app");e&&e.hasAttribute("v-cloak")&&e.removeAttribute("v-cloak")}),setTimeout(()=>{const e=document.getElementById("app");e&&e.hasAttribute("v-cloak")&&e.removeAttribute("v-cloak")},500),r}catch(e){const t=document.getElementById("app");if(t){t.removeAttribute("v-cloak");const o=e instanceof Error?e.message:String(e),r=e instanceof Error?e.stack:String(e);t.innerHTML=`\n        <div style="max-width: 800px; margin: 50px auto; padding: 30px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">\n          <h1 style="color: #f44336; margin-bottom: 20px;">‚ùå Error al cargar la aplicaci√≥n</h1>\n          <div style="background: #fff5f5; border-left: 4px solid #f44336; padding: 15px; margin-bottom: 20px; border-radius: 4px;">\n            <p style="margin: 0; color: #721c24; font-weight: 500;">${o||"Error desconocido"}</p>\n          </div>\n          <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px;">\n            <h3 style="margin-top: 0; color: #333;">Posibles soluciones:</h3>\n            <ul style="color: #666; line-height: 1.8;">\n              <li>Recarga la p√°gina (F5)</li>\n              <li>Revisa la consola del navegador (F12) para m√°s detalles</li>\n              <li>Verifica que el servidor est√© funcionando correctamente</li>\n            </ul>\n          </div>\n          <button onclick="location.reload()" style="background: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;">\n            üîÑ Recargar p√°gina\n          </button>\n          <details style="margin-top: 20px;">\n            <summary style="cursor: pointer; color: #666; font-size: 14px;">Ver detalles t√©cnicos</summary>\n            <pre style="background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; margin-top: 10px; font-size: 12px; color: #333;">${r||String(e)}</pre>\n          </details>\n        </div>\n      `}throw e}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",K):K();
